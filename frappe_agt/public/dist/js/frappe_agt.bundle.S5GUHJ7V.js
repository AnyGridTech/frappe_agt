"use strict";(()=>{var A=Object.defineProperty;var D=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var z=(e,t,n)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,S=(e,t)=>{for(var n in t||(t={}))I.call(t,n)&&z(e,n,t[n]);if(D)for(var n of D(t))V.call(t,n)&&z(e,n,t[n]);return e};frappe.provide("agt.utils.brazil.cnpj");agt.utils.brazil.cnpj.regex=/^(?!00\.000\.000\/0000\-00)(\d{2}\.\d{3}\.\d{3}\/\d{4}\-\d{2})$/;agt.utils.brazil.cnpj.validate=function(e,t){let n=e.doc[t]||"";if(n=n.replace(/\D/g,""),n.length!==14){frappe.msgprint(__("CNPJ must have 14 digits.")),e.set_value(t,"");return}if(agt.utils.brazil.cnpj.regex.test(n)){frappe.msgprint(__("Invalid CNPJ number.")),e.set_value(t,"");return}let r=n.length-2,a=n.substring(0,r),s=n.substring(r),i=0,o=r-7;for(let l=r;l>=1;l--)i+=parseInt(a.charAt(r-l))*o--,o<2&&(o=9);let _=i%11<2?0:11-i%11;if(_!==parseInt(s.charAt(0))){frappe.msgprint(__("Invalid CNPJ number.")),e.set_value(t,"");return}r+=1,a=n.substring(0,r),i=0,o=r-7;for(let l=r;l>=1;l--)i+=parseInt(a.charAt(r-l))*o--,o<2&&(o=9);if(_=i%11<2?0:11-i%11,_!==parseInt(s.charAt(1))){frappe.msgprint(__("Invalid CNPJ number.")),e.set_value(t,"");return}agt.utils.brazil.cnpj.format(e,t)};agt.utils.brazil.cnpj.format=function(e,t){let n=e.doc[t]||"";n=n.replace(/\D/g,""),n.length===14&&e.set_value(t,n.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5"))};agt.utils.brazil.cnpj.validate_existence=async function(e,t){var r;let n=((r=e.doc[t])==null?void 0:r.replace(/\D/g,""))||"";if(n.length!==14){frappe.msgprint(__("CNPJ must have 14 digits to check existence."));return}try{let a=await frappe.call({method:"check_cnpj_existence",args:{cnpj:n}});a.message&&a.message.exists?frappe.msgprint(__("CNPJ exists and is valid.")):frappe.msgprint(__("CNPJ not found in official records."))}catch(a){console.error("Error checking CNPJ existence:",a),frappe.msgprint(__("Error checking CNPJ existence. Please try again."))}};frappe.provide("agt.utils.brazil.cpf");agt.utils.brazil.cpf.regex=/^(?!000\.000\.000\-00)(\d{3}\.\d{3}\.\d{3}\-\d{2})$/;agt.utils.brazil.cpf.validate=function(e,t){let n=e.doc[t]||"";if(n=n.replace(/\D/g,""),n.length!==11){frappe.msgprint(__("CPF must have 11 digits.")),e.set_value(t,"");return}if(agt.utils.brazil.cpf.regex.test(n)){frappe.msgprint(__("Invalid CPF number.")),e.set_value(t,"");return}let r=0,a;for(let s=1;s<=9;s++)r+=parseInt(n.substring(s-1,s))*(11-s);if(a=r*10%11,(a===10||a===11)&&(a=0),a!==parseInt(n.substring(9,10))){frappe.msgprint(__("Invalid CPF number.")),e.set_value(t,"");return}r=0;for(let s=1;s<=10;s++)r+=parseInt(n.substring(s-1,s))*(12-s);if(a=r*10%11,(a===10||a===11)&&(a=0),a!==parseInt(n.substring(10,11))){frappe.msgprint(__("Invalid CPF number.")),e.set_value(t,"");return}agt.utils.brazil.cpf.format(e,t)};agt.utils.brazil.cpf.format=function(e,t){let n=e.doc[t]||"";n=n.replace(/\D/g,""),n.length===11&&e.set_value(t,n.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"))};frappe.provide("agt.utils.brazil");agt.utils.brazil.validate_cnpj_or_cpf=function(e,t,n){if(n==="cpf")agt.utils.brazil.cpf.validate(e,t);else if(n==="cnpj")agt.utils.brazil.cnpj.validate(e,t);else{let r=e.doc[t]||"";r=r.replace(/\D/g,""),r.length===11?agt.utils.brazil.cpf.validate(e,t):r.length===14&&agt.utils.brazil.cnpj.validate(e,t)}};agt.utils.brazil.format_cnpj_or_cpf=function(e,t,n){if(n==="cpf")agt.utils.brazil.cpf.format(e,t);else if(n==="cnpj")agt.utils.brazil.cnpj.format(e,t);else{let r=e.doc[t]||"";r=r.replace(/\D/g,""),r.length===11?agt.utils.brazil.cpf.format(e,t):r.length===14&&agt.utils.brazil.cnpj.format(e,t)}};frappe.provide("agt.utils.brazil");frappe.provide("agt.utils.brazil.cep");agt.utils.brazil.cep.regex=/^\d{5}-?\d{3}$/;agt.utils.brazil.cep.format=function(e,t){let n=e.doc[t]||"";if(n=n.replace(/\D/g,""),n.length===8){let r=`${n.slice(0,5)}-${n.slice(5)}`;return e.set_value(t,r),r}return n};agt.utils.brazil.cep.validate=async function(e,t,n,r,a,s){var c;let i=e.fields_dict[t];if(!(i!=null&&i.$input))return;let o=i.$input,_=f=>{switch(f){case"warning":return'<i class="fa fa-exclamation-circle" style="color:#f1c40f"></i> ';case"error":return'<i class="fa fa-times-circle" style="color:#e74c3c"></i> ';case"success":return'<i class="fa fa-check-circle" style="color:#27ae60"></i> ';default:return""}},l=(f,p)=>{let m="default";f==="#f1c40f"?m="warning":f==="red"||f==="#e74c3c"?m="error":(f==="green"||f==="#27ae60")&&(m="success");let b=_(m);i.set_description(b+(p?`<b style="color:${f}">${p}</b>`:""))},u=async f=>{try{return(await frappe.call({method:"check_cep",args:{cep:f}})).message}catch(p){return console.error("Erro ao consultar o CEP via server script:",p),null}},g=async f=>{let p=f.replace(/\D/g,"");if(!p){l("","");return}if(p.length<8){l("#f1c40f","CEP incompleto");return}let m=await u(p);if(!m||m.message==="CEP n\xE3o encontrado"){l("red","CEP n\xE3o encontrado");return}e.set_value(n,m.street||""),e.set_value(r,m.neighborhood||""),e.set_value(a,m.city||""),e.set_value(s,m.state||""),l("green","CEP v\xE1lido")},y=async f=>{var j;let p=f.target,m=p.value,b=p.selectionStart||0,k=m.slice(0,b).replace(/\D/g,"").length,h=m.replace(/\D/g,"").slice(0,8),v=((j=e.doc[t])==null?void 0:j.toString())||"",x=h.length>v.replace(/\D/g,"").length,w=h;if(x&&h.length>5?w=`${h.slice(0,5)}-${h.slice(5)}`:x||(h.length>5&&m.includes("-")?w=`${h.slice(0,5)}-${h.slice(5)}`:w=h),w!==m){p.value=w,e.doc[t]=w;let P=0,C=0;for(let T of w)if(P++,/\d/.test(T)&&C++,C>=k)break;for(;P<w.length&&w[P]&&/\D/.test(w[P]||"");)P++;p.setSelectionRange(P,P)}await g(w)};o.off(".zipcode").on("input.zipcode",y),((c=e.doc[t])==null?void 0:c.toString())&&o.trigger("input.zipcode")};frappe.provide("agt.utils.brazil");frappe.provide("agt.utils.brazil.phone");agt.utils.brazil.phone.regex=/^\(\d{2}\)\s\d{4,5}\-\d{4}$/;agt.utils.brazil.phone.format=function(e,t){let r=(e.doc[t]||"").replace(/\D/g,"").slice(0,11);if(r.length<=2){e.set_value(t,r);return}if(r.length<=6){e.set_value(t,`(${r.substring(0,2)}) ${r.substring(2)}`);return}if(r.length<=10){e.set_value(t,`(${r.substring(0,2)}) ${r.substring(2,6)}-${r.substring(6)}`);return}e.set_value(t,`(${r.substring(0,2)}) ${r.substring(2,7)}-${r.substring(7)}`)};agt.utils.brazil.phone.validate=function(e,t){return new Promise(n=>{var g;let r=e.fields_dict[t];if(!(r!=null&&r.$input))return console.error(`validate_phone: O campo '${t}' n\xE3o foi encontrado ou n\xE3o \xE9 um campo de entrada v\xE1lido.`),n();let a=r.$input,s=y=>{let d="";switch(y){case"warning":d='<i class="fa fa-exclamation-circle" style="color:#f1c40f"></i> ';break;case"error":d='<i class="fa fa-times-circle" style="color:#e74c3c"></i> ';break;case"success":d='<i class="fa fa-check-circle" style="color:#27ae60"></i> ';break;default:d=""}return d},i=(y,d)=>{let c="default";y==="#f1c40f"?c="warning":y==="red"||y==="#e74c3c"?c="error":(y==="green"||y==="#27ae60")&&(c="success");let f=s(c);r.set_description(f+(d?`<b style='color:${y}'>${d}</b>`:""))},o=y=>{let d=y.replace(/\D/g,"");if(!(d.length===10||d.length===11))return{isValid:!1,type:"invalido"};let f=[0,1,2,3,4,5,6,7,8,9,10,20,23,25,26,29,30,36,39,40,50,52,56,57,58,59,60,70,72,76,78,80,90],p=parseInt(d.substring(0,2));if(!(!f.includes(p)&&p>=11&&p<=99))return{isValid:!1,type:"invalido"};let b=parseInt(d.substring(2,3));return d.length===11&&b===9?{isValid:!0,type:"celular"}:d.length===10&&b>=2&&b<=8?{isValid:!0,type:"fixo"}:{isValid:!1,type:"invalido"}},_=y=>{let d=y.replace(/\D/g,"").slice(0,11);return d.length<=2?d:d.length<=6?`(${d.substring(0,2)}) ${d.substring(2)}`:d.length<=10?`(${d.substring(0,2)}) ${d.substring(2,6)}-${d.substring(6)}`:`(${d.substring(0,2)}) ${d.substring(2,7)}-${d.substring(7)}`},l=y=>{let d=y.target,c=d.value,f=d.selectionStart||0,p=c.slice(0,f).replace(/\D/g,"").length,m=c.replace(/\D/g,""),b=_(m);if(c!==b){d.value=b,e.doc[t]=b;let h=0,v=0;for(let x of b)if(h++,/\d/.test(x)&&v++,v>=p)break;for(;h<b.length&&b[h]&&/\D/.test(b[h]||"");)h++;d.setSelectionRange(h,h)}let k=o(b);m?m.length<10?i("#f1c40f","N\xFAmero de telefone incompleto"):k.isValid?k.type==="celular"?i("green","Celular v\xE1lido"):k.type==="fixo"&&i("green","Telefone fixo v\xE1lido"):i("red","DDD ou n\xFAmero de telefone inv\xE1lido"):i("","")};a.off(".phone").on("input.phone",l),((g=e.doc[t])==null?void 0:g.toString())&&a.trigger("input.phone"),n()})};frappe.provide("agt.utils");agt.utils.workflow_transition=async function(e,t,n){var r;if(!e||!((r=e.states)!=null&&r.frm)||!t){console.error("workflow_transition: Par\xE2metros inv\xE1lidos.");return}frappe.dom.freeze(),e.states.frm.selected_workflow_action=t,e.states.frm.script_manager.trigger("before_workflow_action").then(async()=>{await frappe.xcall("frappe.model.workflow.apply_workflow",{doc:e.states.frm.doc,action:t}).then(a=>{frappe.model.sync(a),e.states.frm.refresh(),e.states.frm.selected_workflow_action=null,e.states.frm.script_manager.trigger("after_workflow_action")}).finally(async()=>{frappe.dom.unfreeze(),n&&await n(e)})})};agt.utils.update_workflow_state=async function(e){let{doctype:t,docname:n,workflow_state:r,ignore_workflow_validation:a,callback:s}=e;return await frappe.call({method:"update_workflow_state",args:{doctype:t,docname:n,workflow_state:r,ignore_workflow_validation:a}}).then(async()=>await agt.utils.refresh_force().then(async i=>(s&&await s(),i)))};agt.utils.refresh_force=async function(){var e,t;if(!((e=cur_frm==null?void 0:cur_frm.doc)!=null&&e.doctype)||!((t=cur_frm==null?void 0:cur_frm.doc)!=null&&t.name)){console.error("refresh_force: cur_frm ou documento inv\xE1lido");return}return frappe.model.clear_doc(cur_frm.doc.doctype,cur_frm.doc.name),await agt.utils.doc.get_doc(cur_frm.doc.doctype,cur_frm.doc.name).then(n=>{var r,a;return(a=(r=cur_frm==null?void 0:cur_frm.states)==null?void 0:r.frm)!=null&&a.refresh&&cur_frm.states.frm.refresh(),n}).catch(n=>{console.error("Error refreshing document:",n)})};agt.utils.validate_cpf_regex=function(e){return!e||typeof e!="string"?!1:(e=e.trim(),/^(?!000\.000\.000\-00)(\d{3}\.\d{3}\.\d{3}\-\d{2})$/.test(e))};agt.utils.validate_cnpj_regex=function(e){return!e||typeof e!="string"?!1:(e=e.trim(),/^(?!00\.000\.000\/0000\-00)(\d{2}\.\d{3}\.\d{3}\/\d{4}\-\d{2})$/.test(e))};agt.utils.validate_cpf=function(e){let t=(e||"").replace(/\D/g,"");if(t.length!==11||/^(\d)\1+$/.test(t))return!1;let n=0;for(let a=0;a<9;a++)n+=+(t[a]||0)*(10-a);let r=n*10%11;if(r===10&&(r=0),r!==+(t[9]||0))return!1;n=0;for(let a=0;a<10;a++)n+=+(t[a]||0)*(11-a);return r=n*10%11,r===10&&(r=0),r===+(t[10]||0)};agt.utils.validate_cnpj=function(e){let t=(e||"").replace(/\D/g,"");if(t.length!==14||/^(\d)\1+$/.test(t))return!1;let n=(o,_)=>o.split("").reduce((l,u,g)=>l+ +(u||0)*(_[g]||0),0),r=[5,4,3,2,9,8,7,6,5,4,3,2],a=[6,...r],s=n(t.slice(0,12),r)%11,i=s<2?0:11-s;return i!==+(t[12]||0)?!1:(s=n(t.slice(0,13),a)%11,i=s<2?0:11-s,i===+(t[13]||0))};agt.utils.validate_cnpj_existence=async function(e){if(!e||typeof e!="string")return!1;let t=e.replace(/\D/g,"");if(t.length!==14)return!1;try{let n=await frappe.call({method:"check_cnpj",args:{cnpj:t}}),r=n==null?void 0:n.message;return!!r&&!!r.cnpj&&r.cnpj.replace(/\D/g,"")===t}catch(n){return console.error("Erro ao validar CNPJ:",n),!1}};agt.utils.format_doc=function(e,t){let n=(e||"").replace(/\D/g,""),r=s=>{let i=s.slice(0,11);return i.length>3&&(i=i.replace(/^(\d{3})(\d)/,"$1.$2")),i.length>6&&(i=i.replace(/^(\d{3})\.(\d{3})(\d)/,"$1.$2.$3")),i.length>9&&(i=i.replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/,"$1.$2.$3-$4")),i},a=s=>{let i=s.slice(0,14);return i.length>2&&(i=i.replace(/^(\d{2})(\d)/,"$1.$2")),i.length>5&&(i=i.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")),i.length>8&&(i=i.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/,"$1.$2.$3/$4")),i.length>12&&(i=i.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/,"$1.$2.$3/$4-$5")),i};return t==="Pessoa F\xEDsica"?r(n):t==="Pessoa Jur\xEDdica"?a(n):n.length<12?r(n):a(n)};agt.utils.document_id=async function(e,t,n){var l;let r=e.fields_dict[t];if(!(r!=null&&r.$input)){console.error(`document_id: O campo '${t}' n\xE3o foi encontrado ou n\xE3o \xE9 um campo de entrada v\xE1lido.`);return}let a=r.$input,s=u=>{let g="";switch(u){case"warning":g='<i class="fa fa-exclamation-circle" style="color:#f1c40f"></i> ';break;case"error":g='<i class="fa fa-times-circle" style="color:#e74c3c"></i> ';break;case"success":g='<i class="fa fa-check-circle" style="color:#27ae60"></i> ';break;default:g=""}return g},i=(u,g)=>{let y="default";u==="#f1c40f"?y="warning":u==="red"||u==="#e74c3c"?y="error":(u==="green"||u==="#27ae60")&&(y="success");let d=s(y);r.set_description(d+(g?`<b style='color:${u}'>${g}</b>`:""))},o=()=>{let g=(a.val()||"").replace(/\D/g,""),y=n?e.doc[n]:null;if(y&&y!=="Pessoa F\xEDsica"&&y!=="Pessoa Jur\xEDdica"){e.set_df_property(t,"read_only",1),e.set_df_property(t,"hidden",1),i("#f1c40f","Selecione o tipo de documento antes de preencher.");return}else e.set_df_property(t,"read_only",0),e.set_df_property(t,"hidden",0);if(!g){i("","");return}if(y==="Pessoa F\xEDsica"){g.length<11?i("#f1c40f","CPF incompleto"):agt.utils.validate_cpf(g)?i("green","CPF v\xE1lido"):i("red","CPF inv\xE1lido. Favor corrigir.");return}if(y==="Pessoa Jur\xEDdica"){g.length<14?i("#f1c40f","CNPJ incompleto"):agt.utils.validate_cnpj(g)?(i("#27ae60","CNPJ v\xE1lido sintaticamente. Verificando exist\xEAncia..."),agt.utils.validate_cnpj_existence(g).then(d=>{d?i("green","CNPJ existe e est\xE1 ativo"):i("red","CNPJ n\xE3o encontrado na base nacional")})):i("red","CNPJ inv\xE1lido. Favor corrigir.");return}if(y===null){if(g.length<11||g.length>11&&g.length<14)i("#f1c40f","CPF ou CNPJ incompleto.");else if(g.length===11)agt.utils.validate_cpf(g)?i("green","CPF v\xE1lido"):i("red","CPF ou CNPJ inv\xE1lido ou incompleto");else if(g.length>=14){let d=g.slice(0,14);agt.utils.validate_cnpj(d)?i("green","CNPJ v\xE1lido"):i("red","CNPJ inv\xE1lido. Favor corrigir.")}}},_=u=>{let g=u.target,y=g.value,d=n?e.doc[n]:null,c=g.selectionStart||0,f=y.slice(0,c).replace(/\D/g,"").length,p=y.replace(/\D/g,""),m=d==="Pessoa Jur\xEDdica"?14:d==="Pessoa F\xEDsica"?11:14;p.length>m&&(p=p.slice(0,m));let b=v=>v.replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})\.(\d{3})(\d)/,"$1.$2.$3").replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/,"$1.$2.$3-$4"),k=v=>v.replace(/(\d{2})(\d)/,"$1.$2").replace(/(\d{2})\.(\d{3})(\d)/,"$1.$2.$3").replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/,"$1.$2.$3/$4").replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/,"$1.$2.$3/$4-$5"),h=p;if(d==="Pessoa F\xEDsica"?h=b(p):d==="Pessoa Jur\xEDdica"?h=k(p):h=p.length>11?k(p):b(p),y!==h){g.value=h,e.doc[t]=h;let v=0,x=0;for(let w of h)if(v++,/\d/.test(w)&&x++,x>=f)break;for(;v<h.length&&h[v]&&/\D/.test(h[v]||"");)v++;g.setSelectionRange(v,v)}o()};a.off(".cpfcnpj").on("input.cpfcnpj",_),n&&((l=e.fields_dict[n])==null?void 0:l.$input)&&e.fields_dict[n].$input.off(`.cpfcnpjtype_${t}`).on(`change.cpfcnpjtype_${t}`,()=>{o(),a.trigger("input.cpfcnpj")}),o()};agt.utils.redirect_by_ref=function(e,t,n,r,a,s=3e3,i=!0){if(!e||!a){console.error("redirect_by_ref: ref e url s\xE3o obrigat\xF3rios");return}frappe.msgprint({title:t||"Redirecionando...",message:n!=null?n:"",indicator:r||"blue"}),setTimeout(()=>{a&&(i?window.open(a,"_blank"):window.location.href=a)},s)};agt.utils.build_doc_url=function(e,t){let n=e.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/\s+/g,"-").replace(/_/g,"-").toLowerCase();return`${window.location.origin}/app/${n}/${encodeURIComponent(t)}`};agt.utils.redirect_after_create_doc=function(e,t,n,r){e?frappe.msgprint({title:"Redirecionando...",message:`${r} criado com sucesso! Voc\xEA ser\xE1 direcionado para o documento (${n}).`,indicator:"green"}):frappe.msgprint({title:"Redirecionando...",message:`Voc\xEA ser\xE1 direcionado para o documento j\xE1 existente (${n}).`,indicator:"blue"}),setTimeout(()=>{window.location.href=t},2e3)};agt.utils.get_item_info=async function(e,t){if(!e||typeof e!="string"){console.error("get_item_info: item_name \xE9 obrigat\xF3rio");return}let n=await frappe.db.get_list("Item",{fields:["item_code","custom_mppt","item_name"]}).catch(o=>(console.error("Erro ao buscar itens:",o),null));if(!n||!n.length)return;let r=agt.utils.text.normalize(e),a=n.filter(o=>agt.utils.text.normalize(o.item_name)===r);if(!a.length)return;let s=[...new Set(a.map(o=>o.custom_mppt))];if(s.length===1)return a[0];let i=`Selecione a quantidade de MPPTs (${e}${t?` - ${t}`:""})`;return new Promise(o=>{agt.utils.dialog.load({title:i,fields:[{fieldname:"mppt",label:"MPPT",fieldtype:"Select",options:s,reqd:!0}],static:!1,draggable:!1,lockClose:!0,primary_action:async function(_){let l=_.mppt;if(!l)return;let u=a.find(g=>g.custom_mppt===l);agt.utils.dialog.close_by_title(i),o(u)}})})};agt.utils.get_growatt_sn_info=async function(e){var t;if(!e||typeof e!="string"){console.error("get_growatt_sn_info: serial_no \xE9 obrigat\xF3rio");return}try{let n=await frappe.call({method:"get_growatt_sn_info",args:{deviceSN:e}});return!n||!((t=n.message)!=null&&t.code)||n.message.code!==200?void 0:n.message}catch(n){console.error("Erro ao buscar informa\xE7\xF5es do SN Growatt:",n);return}};agt.utils.validate_serial_number=function(e,t){if(!e||typeof e!="string")return!1;e=e.trim().toUpperCase();let n=/^[A-Z0-9][A-Z][A-Z0-9]([A-Z0-9]{7}|[A-Z0-9]{13})$/,r=/^[A-Z0-9]{3}[A-Z0-9]{7}$/,a=/^[A-Z0-9]{3}[A-Z0-9]{13}$/,s=!1;return t==="inverter"?s=r.test(e):t==="battery"||t==="ev_charger"?s=a.test(e):s=n.test(e),s};agt.utils.get_value_from_any_doc=async function(e,t,n,r){var s;let a=e.doc[n];if(!a)return null;try{let i=await frappe.db.get_doc(t,a);return(s=i==null?void 0:i[r])!=null?s:null}catch(i){return console.error(`Erro ao buscar campo ${r} do ${t}:`,i),null}};frappe.provide("agt.db");agt.db.filter_join=async function(e){let t=[];for(let n=0;n<e.length;n++){let r=e[n];if(!r)continue;let a=S({},r.filters);if(n>0&&r.joinOn&&t.length>0){let i=r.joinOn,o=t.map(_=>_[i.sourceField]);a[i.targetField]=["in",o]}if(r.joinOn&&t.length===0){console.warn(`No results found for step ${n+1}. Skipping further joins.`);break}t=(await frappe.call({method:"backend_get_all",args:{doctype:r.doctype,filters:a,fields:r.fields}})).message.data||[]}return t};frappe.provide("agt.utils.dialog");agt.utils.dialog.created=[];agt.utils.dialog.load=function(e){let t=new frappe.ui.Dialog(e);return agt.utils.dialog.created.push(t),$(t.wrapper).on("hidden.bs.modal",()=>{let n=agt.utils.dialog.created.indexOf(t);n>-1&&(agt.utils.dialog.created.splice(n,1),agt.utils.dialog.refresh_dialog_stacking())}),t.show(),setTimeout(()=>agt.utils.dialog.refresh_dialog_stacking(),50),t};agt.utils.dialog.close_all=function(){[...agt.utils.dialog.created].forEach(t=>{var n;if(t){t.hide();let r=(n=$(t.wrapper).data("bs.modal"))==null?void 0:n.$backdrop;r==null||r.remove()}}),agt.utils.dialog.created=[]};agt.utils.dialog.close_by_title=function(e){var n;let t=agt.utils.dialog.created.findIndex(r=>r.title===e);if(t>=0){let r=agt.utils.dialog.created[t];if(r){r.hide();let a=(n=$(r.wrapper).data("bs.modal"))==null?void 0:n.$backdrop;a==null||a.remove(),agt.utils.dialog.created.splice(t,1),agt.utils.dialog.refresh_dialog_stacking()}}};agt.utils.dialog.show_debugger_alert=function(e,t,n,r=10){frappe.user.has_role(["IT","Administrator","System Manager"])&&frappe.show_alert({message:__(t),indicator:n},r)};agt.utils.dialog.refresh_dialog_stacking=function(){if(typeof $=="undefined"){console.error("jQuery is not loaded. Unable to refresh dialog stacking.");return}let e=1051,t=1050;agt.utils.dialog.created.forEach((n,r)=>{var a;if($(n.wrapper).is(":visible")){let s=e+r*2;$(n.wrapper).css("z-index",s);let i=$(n.wrapper).attr("id");$(`.modal-backdrop[data-modal-id="${i}"]`).css("z-index",t+r*2);let o=(a=$(n.wrapper).data("bs.modal"))==null?void 0:a.$backdrop;o&&!o.attr("data-modal-id")&&o.attr("data-modal-id",i)}})};frappe.provide("agt.utils.doc");agt.utils.doc.create_doc=async function(e,t,n){let r=await agt.utils.doc.get_doc_meta(e);if(!r){frappe.throw(`Could not fetch meta for doctype: ${e}`);return}let a=Object.entries(n).reduce((l,[u,g])=>((typeof g.value=="number"||typeof g.value=="string")&&(l[u]=g.value),l),{}),s=r.fields.map(l=>l.fieldname);for(let l of t){if(!s.includes(l))continue;let u;l==="docname"&&(cur_frm==null?void 0:cur_frm.docname)?u=cur_frm.docname:(cur_frm==null?void 0:cur_frm.doc)&&l in cur_frm.doc&&(u=cur_frm.doc[l]),u!==void 0&&(a[l]=u)}let i={};for(let[l,u]of Object.entries(a))!s.includes(l)||u==null||u===""||(i[l]=u);if(Object.keys(i).length===0){frappe.throw(`No valid fields to create the document: ${e}`);return}let o=frappe.model.get_new_doc(e);for(let[l,u]of Object.entries(i))l==="workflow_state"||l==="naming_series"||(o[l]=u);let _=await frappe.db.insert(o).catch(l=>console.error(l));return _==null?void 0:_.name};agt.utils.doc.update_doc=async function(e,t,n,r=0){var s;if(r>=3){console.error(`Max retries (${3}) reached. Aborting update.`);return}try{let i=await frappe.db.get_doc(e,t).catch(l=>console.error(l));if(!i){console.error(`Document '${t}' not found.`);return}let o={},_=["workflow_state","naming_series","creation","doctype","modified","name","owner"];for(let[l,u]of Object.entries(n))_.includes(l)&&e!=="Serial No"||i[l]!==void 0&&i[l]!==u&&(i[l]===null&&u===""||i[l]===""&&u===null||(console.log(`[${e} - ${t}] Setting ${l} to ${u}`),i[l]=u,o[l]=u));if(Object.keys(o).length===0){console.log(`[${e} - ${t}] No valid fields to update`);return}if(await frappe.call({method:"frappe.client.save",args:{doc:i}}),e===cur_frm.doctype&&t===cur_frm.docname){let l=await frappe.call({method:"frappe.client.get",args:{doctype:e,name:t}}).then(({message:u})=>u);frappe.model.sync([l]),cur_frm.states.frm.refresh()}console.log(`Document '${t}' updated successfully.`)}catch(i){if((s=i==null?void 0:i.message)!=null&&s.includes("Document has been modified after you have opened it"))return console.warn("Timestamp mismatch detected. Refetching document..."),await agt.utils.doc.update_doc(e,t,n,r+1);console.error(`Error saving document '${t}':`,i)}};agt.utils.doc.get_doc=async function(e,t){return await frappe.call({method:"frappe.client.get",args:{doctype:e,name:t}}).then(async n=>(frappe.model.clear_doc(e,t),frappe.model.sync([n.message]),cur_frm.states.frm.refresh(),n.message))};agt.utils.doc.share_doc=async function(e,t,n){let r=await frappe.call({method:"frappe.share.get_users",args:{doctype:e,name:t}}).then(({message:a})=>a);for(let a of n){let s=r.find(i=>i.user===a.user);if((s==null?void 0:s.read)===a.read&&(s==null?void 0:s.write)===a.write&&(s==null?void 0:s.share)===a.share){console.log(`Document '${t}' already shared with user '${a.user}'`);continue}await frappe.call({method:"frappe.share.add",args:{doctype:e,name:t,user:a.user,read:a.read,write:a.write,share:a.share,owner:a.owner||frappe.session.user_email}}).then(()=>console.log(`Document '${t}' shared with user '${a.user}'`))}};agt.utils.doc.get_doc_meta=async function(e){return await frappe.model.with_doctype(e),frappe.get_meta(e)};frappe.provide("agt.utils.form");frappe.provide("agt.utils.form.field");agt.utils.form.field.is_empty=function(e){return e?e.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim()==="":!0};agt.utils.form.field.set_properties=function(e,t){Object.entries(t).forEach(([n,r])=>{r.hidden!==void 0&&e.$wrapper.find(`[data-fieldname='${n}']`).toggle(!r.hidden),r.readonly!==void 0&&e.set_df_property(n,"read_only",r.readonly?1:0),r.reqd!==void 0&&e.set_df_property(n,"reqd",r.reqd?1:0),r.label!==void 0&&e.set_df_property(n,"label",r.label),r.description!==void 0&&e.set_df_property(n,"description",r.description)}),e.refresh_fields()};agt.utils.form.field.get_js_visible_fields=function(e){let t=[];for(let n of Object.values(e.fields_dict)){if(["Table","Section Break","Column Break","HTML","Fold"].includes(n.df.fieldtype)||!n.df.depends_on)continue;let r=n.df.depends_on.replace("eval:","");frappe.utils.eval(r,{doc:e.doc})&&t.push(n)}return t};agt.utils.form.field.validate_js_visible_fields=function(e,t){let n=agt.utils.form.field.get_js_visible_fields(e),r=__("Aten\xE7\xE3o!"),a="red";function s(_){let l=[];for(let g of _)l.push(`<li>${g.df.label}</li>`);return`<p>${__("\u26A0\uFE0F Os campos abaixo s\xE3o obrigat\xF3rios: ")}</p><ul>${l.join("")}</ul>`}return{throw_error:()=>{if(t!==e.doc.workflow_state||!n.length)return;let _=s(n);frappe.throw({title:r,message:_,indicator:a})},msgprint:()=>{if(t!==e.doc.workflow_state||!n.length)return;let _=s(n);frappe.msgprint({title:r,message:_,indicator:a})}}};agt.utils.form.field.turn_into_link=function(e,t,n){let r=e.fields_dict[t];if(r&&r.df.read_only&&r.$wrapper){let a=r.$wrapper;a.css("position","relative"),a.find(".serial-link-mask").remove(),a.append(`<a class="serial-link-mask" href="/app/${n}/${encodeURIComponent(e.doc[t])}" target="_blank"
        style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;z-index:10;cursor:pointer;"></a>`)}};agt.utils.form.mirror_checklist_table=async function(e,t,n,r,a,s){let i=e.doc.name,o=["name"];s&&o.push("workflow_state");let _=await frappe.db.get_list(t,{filters:{[r]:i},fields:o}).catch(g=>(console.error(`Error fetching ${t}:`,g),[])),l=e.doc[n]||[];if(!!await agt.utils.table.is_sync(l,_,a,s)){console.log(`Tabela '${n}' j\xE1 est\xE1 sincronizada.`);return}e.doc[n]=_.map(g=>{let y={[a]:g.name};return s&&g.workflow_state&&(y[s]=g.workflow_state),y}),e.dirty(),e.refresh_field(n),await e.save(),console.log(`Tabela '${n}' sincronizada.`)};agt.utils.form.assign_parent_doc_name=function(e){};agt.utils.form.adjust_html_elements=function(e,t){var r;if(!(e!=null&&e.doc))return;Object.entries({removeTabs:".form-tabs-list",removeNavFormsTabs:".nav.form-tabs",removeSidebar:".col-lg-2.layout-side-section",removeAssignments:".form-assignments",removeAssignmentsButton:".button.add-assignments-btn",removeAttachments:".form-attachments",removeAttachmentsButton:".button.add-attachments-btn",removeShared:".form-shared",removeTags:".form-tags",removeSidebarStats:".form-sidebar-stats",removeSidebarMenu:".list-unstyled.sidebar-menu.text-muted",removeSidebarReset:"button.btn-reset.sidebar-toggle-btn",removeSidebarToggle:"span.sidebar-toggle-btn",removeActivityBar:".form-footer"}).forEach(([a,s])=>{if(t[a]){let i=document.querySelector(s);i&&(i.style.display="none",i.remove())}}),t.removeTabs&&!document.querySelector(".form-tabs-list")&&((r=document.querySelector(".form-layout"))==null||r.setAttribute("style","border-top: none"))};agt.utils.form.render_doc_fields_table=async function(e,t,n,r){var y,d;if(!e||!t||!(n!=null&&n.length)){console.error("[render_doc_fields_table] Invalid arguments!");return}let a=Array.isArray(t)||typeof t=="object"&&t!==null&&"length"in t&&typeof t.length=="number",s=a?Array.isArray(t)?t.filter(c=>typeof c=="object"&&c!==null):Array.from(t).filter(c=>typeof c=="object"&&c!==null):[];if(!r){let c=a&&s.length>0?(y=s[0])==null?void 0:y.doctype:t==null?void 0:t.doctype;c&&(r=await((d=frappe.get_meta)==null?void 0:d.call(frappe,c)))}let i=c=>c==null?"":String(c).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"),o=c=>{var p;let f=(p=r==null?void 0:r.fields)==null?void 0:p.find(m=>m.fieldname===c.fieldname);return{label:c.label||(f==null?void 0:f.label)||c.fieldname,fieldtype:(f==null?void 0:f.fieldtype)||"Data",options:f==null?void 0:f.options}},_=(c,f,p)=>{var m,b;if(c==null||c==="")return'<span class="text-muted">\u2014</span>';switch(f){case"Link":if(p&&c!=null){let v=String(p).toLowerCase().replace(/\s+/g,"-"),x=i(c);return`<a href="/app/${i(v)}/${encodeURIComponent(String(c))}" target="_blank">${x}</a>`}return i(c);case"Select":return`<span class="badge badge-light">${i(c)}</span>`;case"Date":case"Datetime":let k=(m=frappe==null?void 0:frappe.datetime)!=null&&m.str_to_user?frappe.datetime.str_to_user(c):String(c);return i(k);case"Currency":case"Float":case"Int":let h=(b=window.frappe)!=null&&b.format_value?window.frappe.format_value(c,{fieldtype:f}):String(c);return i(h);case"Check":return c?'<span class="text-success">\u2713 Sim</span>':'<span class="text-danger">\u2717 N\xE3o</span>';default:return i(c)}},l="",u="";a?s.length===0?l=`<tr><td colspan="${n.length}" class="text-center text-muted">Nenhum dado encontrado.</td></tr>`:(l=s.map(c=>"<tr>"+n.map(f=>{let p=o(f),m=c[f.fieldname],b=f.formatter?f.formatter(m,c,p):_(m,p.fieldtype,p.options);return`<td${p.fieldtype==="Link"?' data-debug-link="true"':""}>${b}</td>`}).join("")+"</tr>").join(""),u="<tr>"+n.map(c=>{let f=o(c),p=c.label||f.label||c.fieldname;return`<th class="text-muted">${i(p)}</th>`}).join("")+"</tr>"):l=n.map(c=>{let f=o(c),p=t[c.fieldname],m=c.formatter?c.formatter(p,t,f):_(p,f.fieldtype,f.options),b=c.label||f.label||c.fieldname;return`<tr><td>${i(b)}</td><td>${m}</td></tr>`}).join("");let g=`<div class="form-section" style="margin-bottom: 16px;">
      <div class="table-responsive" style="border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden;">
        <table class="table table-bordered" style="margin: 0; border: none;">
          ${u?`<thead class="table-header">${u}</thead>`:""}
          <tbody>
            ${l}
          </tbody>
        </table>
      </div>
    </div>`;typeof e.html=="function"||typeof window!="undefined"&&window.jQuery&&e instanceof window.jQuery?e.html(g):e instanceof HTMLElement&&(e.innerHTML=g)};agt.utils.form.set_button_primary_style=function(e,t){let n=e.fields_dict[t];if(!(n!=null&&n.$input)){console.warn(`Campo '${t}' n\xE3o encontrado ou n\xE3o \xE9 um bot\xE3o v\xE1lido.`);return}if(n.df.fieldtype==="Button"){let r=n.$input;r&&r.length&&(r.removeClass("btn-default btn-secondary btn-success btn-warning btn-danger btn-info btn-light btn-dark"),r.addClass("btn-primary"))}else console.warn(`Campo '${t}' n\xE3o \xE9 do tipo Button.`)};agt.utils.form.transport_values=function(e,t){if(!agt.src_frm||!e.doc.__islocal)return;let n=e.meta.fields.map(r=>r.fieldname);Object.entries(agt.src_frm.fields_dict).forEach(([r,a])=>{!a.value||typeof a.value=="string"&&a.value.trim()===""||!n.includes(r)||e.doc[r]!==a.value&&(console.log(`Setting ${r} to ${a.value}`),e.set_value(r,a.value))}),e.set_value(t,agt.src_frm.docname),e.save()};frappe.provide("agt.utils.table");frappe.provide("agt.utils.table.row");agt.utils.table.row.add_one=async function(e,t,n){let r=agt.utils.text.to_snake_case(t),a=e.add_child(r,n);return e.dirty(),e.refresh_field(r),await e.save(),a};agt.utils.table.row.add_many=async function(e,t,n){let r=agt.utils.text.to_snake_case(t),a=[];return n.forEach(s=>{let i=e.add_child(r,s);a.push(i)}),e.dirty(),e.refresh_field(r),await e.save(),a};agt.utils.table.row.update_one=async function(e,t){let n=e.doctype||e.parenttype||"Unknown";await Promise.all(Object.entries(t).map(([r,a])=>frappe.model.set_value(n,e.name,r,a)))};agt.utils.table.row.delete_one=async function(e,t,n){frappe.model.clear_doc(t,n)};agt.utils.table.row.get_one=function(e,t,n){let r=agt.utils.text.to_snake_case(t),a=e.doc[r];if(!!a)return a.find(s=>{for(let[i,o]of Object.entries(n))if(s[i]!==o)return!1;return!0})};agt.utils.table.row.get_last=function(e,t){let n=agt.utils.text.to_snake_case(t),r=e.doc[n];if(!!r)return r[r.length-1]};agt.utils.table.row.find=function(e,t,n){let r=agt.utils.text.to_snake_case(t),a=e.doc[r];return a?a.filter(s=>{if(!n.and&&!n.or)return!1;let i=!0,o=!1;if(n.and){for(let[_,l]of Object.entries(n.and))if(s[_]!==l){i=!1;break}}if(n.or)for(let[_,l]of Object.entries(n.or)){if(Array.isArray(l)&&l.includes(s[_])){o=!0;break}if(s[_]===l){o=!0;break}}else o=!0;return i&&o}):[]};agt.utils.table.row.update_last=async function(e,t,n){let r=agt.utils.table.row.get_last(e,t);!r||await agt.utils.table.row.update_one(r,n)};agt.utils.table.is_sync=async function(e,t,n,r){if(e.length!==t.length)return!1;let a=new Map(e.map(o=>[o[n],o])),s=new Map(t.map(o=>[o.name,o]));return e.every(o=>s.get(o[n]))&&t.every(o=>a.has(o.name))?r?!t.some(o=>{let _=a.get(o.name);return _&&_[r]!==o.workflow_state}):!0:!1};agt.utils.table.set_custom_properties=async function(e,t,n,r,a,s){var g,y;let i={hide_add_row:".grid-add-row",hide_remove_row:".grid-remove-rows",hide_remove_all_rows:".grid-remove-all-rows",hide_row_check:".grid-row-check",hide_append_row:".grid-append-row",hide_shortcuts:".grid-shortcuts",hide_check:".grid-body .grid-row .grid-row-check",hide_grid_delete_row:".grid-delete-row",hide_grid_move_row:".grid-move-row"},o=e.fields_dict[n];if(!((g=o==null?void 0:o.grid)!=null&&g.wrapper))return;let _=(d,c)=>{if(!(!a||!Array.isArray(a))&&a.length>0){let f=a[Math.min(c,a.length-1)]||a[0];f&&Object.entries(f).forEach(([p,m])=>{(!(p in d)||d[p]===void 0)&&(d[p]=m)})}},l=()=>{var d;Object.entries(i).forEach(([c,f])=>{t[c]&&o.grid&&o.grid.wrapper&&o.grid.wrapper.find(f).hide()}),(t==null?void 0:t.hide_config_columns)===!0&&($(`div[data-fieldname="${n}"] div.col.grid-static-col.d-flex.justify-content-center`).css({visibility:"hidden"}),(d=e.fields_dict[n])!=null&&d.$wrapper&&e.fields_dict[n].$wrapper.find("div.col.grid-static-col.d-flex.justify-content-center").css({visibility:"hidden"}))},u=o.grid;if(u&&!u._visibility_hooks_attached){if(u._visibility_hooks_attached=!0,typeof u.add_new_row=="function"){let d=u.add_new_row;u.add_new_row=function(...c){let f=d.apply(this,c);if(f&&a&&Array.isArray(a)&&a.length>0){let p=e.doc[n]||[],m=p.length-1,b=s===void 0||s===!1||s===!0&&m===0;m>=0&&p[m]&&b&&(_(p[m],m),setTimeout(()=>{u.refresh()},100))}return l(),f}}if(typeof u.refresh=="function"){let d=u.refresh;u.refresh=function(...c){let f=d.apply(this,c);return l(),f}}}if((t==null?void 0:t.hidden)!==void 0&&e.set_df_property(n,"hidden",t.hidden?1:0),(t==null?void 0:t.read_only)!==void 0&&e.set_df_property(n,"read_only",t.read_only?1:0),(t==null?void 0:t.reqd)!==void 0&&e.set_df_property(n,"reqd",t.reqd?1:0),(t==null?void 0:t.label)!==void 0&&e.set_df_property(n,"label",t.label),(t==null?void 0:t.description)!==void 0&&e.set_df_property(n,"description",t.description),(t==null?void 0:t.cannot_add_rows)!==void 0&&e.set_df_property(n,"cannot_add_rows",t.cannot_add_rows?1:0),(t==null?void 0:t.cannot_delete_rows)!==void 0&&e.set_df_property(n,"cannot_delete_rows",t.cannot_delete_rows?1:0),r&&e.fields_dict[n]&&e.fields_dict[n].grid){e.refresh_field(n);let d=e.fields_dict[n].grid,c=(y=d==null?void 0:d.wrapper)==null?void 0:y.find(".grid-add-row");c&&c.length&&c.text(r)}};agt.utils.table.custom_add_row_button=function(e,t,n){var r;if(e.fields_dict[t]&&e.fields_dict[t].grid){e.refresh_field(t);let a=e.fields_dict[t].grid,s=(r=a==null?void 0:a.wrapper)==null?void 0:r.find(".grid-add-row");s&&s.length&&s.text(n)}};frappe.provide("agt.utils.text");agt.utils.text.normalize=function(e){return(e||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[-_\s]/g,"").replace(/[^a-z0-9]/g,"")};agt.utils.text.is_valid=function(e){return e!=null&&(typeof e=="string"?e.trim()!=="":!0)};agt.utils.text.to_snake_case=function(e){return e=e.replace(/\s+/g,"_"),e=e.replace(/([a-z])([A-Z])/g,"$1_$2"),e.toLowerCase()};agt.utils.text.to_pascal_case_spaced=function(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[^a-zA-Z0-9 ]/g," ").split(/\s+/).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")};})();
//# sourceMappingURL=frappe_agt.bundle.S5GUHJ7V.js.map
